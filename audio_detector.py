"""
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                     –î–µ—Ç–µ–∫—Ç–æ—Ä –∑–≤—É–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –±–∞–Ω–∫–∏ –ø–∏–≤–∞ üç∫                    ‚ïë
‚ïë                                                                              ‚ïë
‚ïë  –≠—Ç–æ—Ç –º–æ–¥—É–ª—å –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω–æ–≥–æ –∑–≤—É–∫–∞ "–ø—à–∏–∫" –±–∞–Ω–∫–∏.     ‚ïë
‚ïë                                                                              ‚ïë
‚ïë  –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ:                                                 ‚ïë
‚ïë  1. –ú–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –∑–≤—É–∫                                       ‚ïë
‚ïë  2. –ö–æ–≥–¥–∞ —Å–ª—ã—à–∏–º –≥—Ä–æ–º–∫–∏–π –∑–≤—É–∫ - –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –µ–≥–æ                             ‚ïë
‚ïë  3. –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å —ç—Ç–∞–ª–æ–Ω–Ω—ã–º–∏ –∑–∞–ø–∏—Å—è–º–∏ –æ—Ç–∫—Ä—ã—Ç–∏—è –±–∞–Ω–∫–∏                         ‚ïë
‚ïë  4. –ï—Å–ª–∏ –ø–æ—Ö–æ–∂–µ—Å—Ç—å > 55% - —ç—Ç–æ –ø–∏–≤–æ!                                        ‚ïë
‚ïë                                                                              ‚ïë
‚ïë  –≠—Ç–∞–ª–æ–Ω—ã:                                                                    ‚ïë
‚ïë  - template_close - –∑–∞–ø–∏—Å—å —Å –±–ª–∏–∑–∫–æ–≥–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è (–≥—Ä–æ–º–∫–∏–π —á—ë—Ç–∫–∏–π –∑–≤—É–∫)      ‚ïë
‚ïë  - template_far   - –∑–∞–ø–∏—Å—å —Å –¥–∞–ª—å–Ω–µ–≥–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è (—Ç–∏—à–µ, –±–æ–ª—å—à–µ —ç—Ö–∞)         ‚ïë
‚ïë                                                                              ‚ïë
‚ïë  –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–∑ –¥–≤—É—Ö —Å—Ä–∞–≤–Ω–µ–Ω–∏–π.                              ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
"""

import numpy as np      # –†–∞–±–æ—Ç–∞ —Å –º–∞—Å—Å–∏–≤–∞–º–∏ —á–∏—Å–µ–ª (–º–∞—Ç–µ–º–∞—Ç–∏–∫–∞)
import pyaudio          # –ó–∞–ø–∏—Å—å –∑–≤—É–∫–∞ —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
import time             # –†–∞–±–æ—Ç–∞ —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º (cooldown)
from collections import deque  # –û—á–µ—Ä–µ–¥—å –¥–ª—è –±—É—Ñ–µ—Ä–∞ –∞—É–¥–∏–æ
from scipy import signal      # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ —ç—Ç–∞–ª–æ–Ω–Ω—ã–µ –∑–≤—É–∫–∏
from config import AUDIO_SETTINGS, DETECTOR_SETTINGS
from beer_sound_template import get_cached_template, get_cached_template_far, TEMPLATE_SAMPLE_RATE


class BeerCanDetector:
    """
    –î–µ—Ç–µ–∫—Ç–æ—Ä –∑–≤—É–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –±–∞–Ω–∫–∏ –ø–∏–≤–∞.
    
    –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:
    1. –°–ª—É—à–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω
    2. –ü—Ä–∏ –≥—Ä–æ–º–∫–æ–º –∑–≤—É–∫–µ - –∏–∑–≤–ª–µ–∫–∞–µ–º "–æ—Ç–ø–µ—á–∞—Ç–æ–∫" –∑–≤—É–∫–∞ (—Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏)
    3. –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –æ—Ç–ø–µ—á–∞—Ç–æ–∫ —Å —ç—Ç–∞–ª–æ–Ω–Ω—ã–º–∏ –∑–∞–ø–∏—Å—è–º–∏
    4. –ï—Å–ª–∏ –ø–æ—Ö–æ–∂–µ - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º True
    
    –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∑–≤—É–∫–∞ (—á—Ç–æ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º):
    - –û–≥–∏–±–∞—é—â–∞—è (envelope) - –∫–∞–∫ –º–µ–Ω—è–µ—Ç—Å—è –≥—Ä–æ–º–∫–æ—Å—Ç—å –≤–æ –≤—Ä–µ–º–µ–Ω–∏
    - –°–ø–µ–∫—Ç—Ä (spectrum) - –∫–∞–∫–∏–µ —á–∞—Å—Ç–æ—Ç—ã –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç
    - –ü–æ–∑–∏—Ü–∏—è –ø–∏–∫–∞ - –≥–¥–µ —Å–∞–º—ã–π –≥—Ä–æ–º–∫–∏–π –º–æ–º–µ–Ω—Ç
    - –°–∫–æ—Ä–æ—Å—Ç—å –Ω–∞—Ä–∞—Å—Ç–∞–Ω–∏—è (attack) - –∫–∞–∫ –±—ã—Å—Ç—Ä–æ —Å—Ç–∞–ª–æ –≥—Ä–æ–º–∫–æ
    - –°–∫–æ—Ä–æ—Å—Ç—å –∑–∞—Ç—É—Ö–∞–Ω–∏—è (decay) - –∫–∞–∫ –±—ã—Å—Ç—Ä–æ —Å—Ç–∞–ª–æ —Ç–∏—Ö–æ
    
    –ó–≤—É–∫ –æ—Ç–∫—Ä—ã—Ç–∏—è –±–∞–Ω–∫–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–µ–Ω:
    - –û—á–µ–Ω—å –±—ã—Å—Ç—Ä—ã–º –Ω–∞—Ä–∞—Å—Ç–∞–Ω–∏–µ–º (—â–µ–ª—á–æ–∫)
    - –ë—ã—Å—Ç—Ä—ã–º –∑–∞—Ç—É—Ö–∞–Ω–∏–µ–º
    - –•–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–º–∏ —á–∞—Å—Ç–æ—Ç–∞–º–∏ "–ø—à–∏–∫–∞"
    """
    
    def __init__(self):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–µ—Ç–µ–∫—Ç–æ—Ä–∞.
        
        –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ —ç—Ç–∞–ª–æ–Ω–Ω—ã–µ –∑–≤—É–∫–∏.
        """
        # PyAudio - –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∞—É–¥–∏–æ
        self.audio = pyaudio.PyAudio()
        self.stream = None      # –ê—É–¥–∏–æ –ø–æ—Ç–æ–∫ (–ø–æ–∫–∞ –Ω–µ –æ—Ç–∫—Ä—ã—Ç)
        self.is_running = False # –†–∞–±–æ—Ç–∞–µ–º –ª–∏ —Å–µ–π—á–∞—Å
        
        # ===== –ù–ê–°–¢–†–û–ô–ö–ò –ê–£–î–ò–û =====
        self.rate = AUDIO_SETTINGS["rate"]         # 44100 Hz - —á–∞—Å—Ç–æ—Ç–∞ –¥–∏—Å–∫—Ä–µ—Ç–∏–∑–∞—Ü–∏–∏
        self.chunk = AUDIO_SETTINGS["chunk"]       # 2048 - —Ä–∞–∑–º–µ—Ä –±—É—Ñ–µ—Ä–∞
        self.channels = AUDIO_SETTINGS["channels"] # 1 - –º–æ–Ω–æ
        
        # ===== –ù–ê–°–¢–†–û–ô–ö–ò –î–ï–¢–ï–ö–¢–û–†–ê =====
        self.similarity_threshold = DETECTOR_SETTINGS["similarity_threshold"]  # 0.55 (55%)
        self.peak_threshold = DETECTOR_SETTINGS["peak_threshold"]              # 0.1
        self.cooldown = DETECTOR_SETTINGS["cooldown"]                          # 3 —Å–µ–∫
        self.debug_mode = DETECTOR_SETTINGS.get("debug_mode", False)
        
        # ===== –ó–ê–ì–†–£–ñ–ê–ï–ú –≠–¢–ê–õ–û–ù–ù–´–ï –ó–í–£–ö–ò =====
        # –î–≤–∞ —ç—Ç–∞–ª–æ–Ω–∞: —Å –±–ª–∏–∑–∫–æ–≥–æ –∏ –¥–∞–ª—å–Ω–µ–≥–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è
        self.template_close = get_cached_template()
        self.template_far = get_cached_template_far()
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —ç—Ç–∞–ª–æ–Ω–æ–≤ (–¥–µ–ª–∞–µ–º —ç—Ç–æ –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ)
        self.template_close_features = self._extract_features(self.template_close)
        self.template_far_features = self._extract_features(self.template_far)
        
        # ===== –°–û–°–¢–û–Ø–ù–ò–ï =====
        self.last_trigger_time = 0  # –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è
        self.last_debug_time = 0    # –î–ª—è –æ—Ç–ª–∞–¥–æ—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        
        # –ë—É—Ñ–µ—Ä –¥–ª—è –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è –∞—É–¥–∏–æ (300–º—Å = 0.3 —Å–µ–∫)
        # –ù—É–∂–µ–Ω —á—Ç–æ–±—ã –∑–∞—Ö–≤–∞—Ç–∏—Ç—å –≤–µ—Å—å –∑–≤—É–∫ –æ—Ç–∫—Ä—ã—Ç–∏—è —Ü–µ–ª–∏–∫–æ–º
        self.audio_buffer = deque(maxlen=int(self.rate * 0.3))
        
        # –§–æ–Ω–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å —à—É–º–∞ (–∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π)
        self.background_levels = deque(maxlen=30)
        self.background_level = 0.01
    
    
    # ========================================================================
    # –ò–ó–í–õ–ï–ß–ï–ù–ò–ï –•–ê–†–ê–ö–¢–ï–†–ò–°–¢–ò–ö –ó–í–£–ö–ê
    # ========================================================================
    
    def _extract_features(self, audio_data: np.ndarray) -> dict:
        """
        –ò–∑–≤–ª–µ—á—å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ (–æ—Ç–ø–µ—á–∞—Ç–æ–∫) –∑–≤—É–∫–∞.
        
        –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
            audio_data: –º–∞—Å—Å–∏–≤ numpy —Å –∞—É–¥–∏–æ –¥–∞–Ω–Ω—ã–º–∏
        
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
            dict —Å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º–∏:
            - envelope: –æ–≥–∏–±–∞—é—â–∞—è —Å–∏–≥–Ω–∞–ª–∞ (–∫–∞–∫ –º–µ–Ω—è–µ—Ç—Å—è –≥—Ä–æ–º–∫–æ—Å—Ç—å)
            - spectrum: —á–∞—Å—Ç–æ—Ç–Ω—ã–π —Å–ø–µ–∫—Ç—Ä (–∫–∞–∫–∏–µ —á–∞—Å—Ç–æ—Ç—ã –µ—Å—Ç—å)
            - peak_position: –≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ø–∏–∫ (0.0 - –Ω–∞—á–∞–ª–æ, 1.0 - –∫–æ–Ω–µ—Ü)
            - attack_rate: —Å–∫–æ—Ä–æ—Å—Ç—å –Ω–∞—Ä–∞—Å—Ç–∞–Ω–∏—è
            - decay_rate: —Å–∫–æ—Ä–æ—Å—Ç—å –∑–∞—Ç—É—Ö–∞–Ω–∏—è
            - duration: –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
        """
        
        # ----- –û–ì–ò–ë–ê–Æ–©–ê–Ø (ENVELOPE) -----
        # –ë–µ—Ä—ë–º –∞–±—Å–æ–ª—é—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (–≥—Ä–æ–º–∫–æ—Å—Ç—å –±–µ–∑ –∑–Ω–∞–∫–∞)
        envelope = np.abs(audio_data)
        
        # –°–≥–ª–∞–∂–∏–≤–∞–µ–º –æ–≥–∏–±–∞—é—â—É—é (—É–±–∏—Ä–∞–µ–º —à—É–º)
        window_size = min(100, len(envelope) // 4)
        if window_size > 0:
            # –°–∫–æ–ª—å–∑—è—â–µ–µ —Å—Ä–µ–¥–Ω–µ–µ
            envelope_smooth = np.convolve(envelope, np.ones(window_size)/window_size, mode='same')
        else:
            envelope_smooth = envelope
        
        # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º (–ø—Ä–∏–≤–æ–¥–∏–º –∫ –¥–∏–∞–ø–∞–∑–æ–Ω—É 0-1)
        max_env = np.max(envelope_smooth)
        if max_env > 0:
            envelope_normalized = envelope_smooth / max_env
        else:
            envelope_normalized = envelope_smooth
        
        # ----- –°–ü–ï–ö–¢–† (–ß–ê–°–¢–û–¢–´) -----
        # FFT (–±—ã—Å—Ç—Ä–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –§—É—Ä—å–µ) - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–∞–∫–∏–µ —á–∞—Å—Ç–æ—Ç—ã –µ—Å—Ç—å –≤ –∑–≤—É–∫–µ
        fft = np.abs(np.fft.rfft(audio_data))
        fft_normalized = fft / (np.max(fft) + 0.0001)  # +0.0001 —á—Ç–æ–±—ã –Ω–µ –¥–µ–ª–∏—Ç—å –Ω–∞ 0
        
        # ----- –ü–û–ó–ò–¶–ò–Ø –ü–ò–ö–ê -----
        # –ì–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å–∞–º—ã–π –≥—Ä–æ–º–∫–∏–π –º–æ–º–µ–Ω—Ç (–æ—Ç 0 –¥–æ 1)
        peak_pos = np.argmax(np.abs(audio_data)) / len(audio_data)
        
        # ----- –°–ö–û–†–û–°–¢–¨ –ù–ê–†–ê–°–¢–ê–ù–ò–Ø (ATTACK) -----
        # –ö–∞–∫ –±—ã—Å—Ç—Ä–æ –∑–≤—É–∫ –¥–æ—Å—Ç–∏–≥ –º–∞–∫—Å–∏–º—É–º–∞
        peak_idx = np.argmax(np.abs(audio_data))
        if peak_idx > 0:
            attack_rate = np.max(np.abs(audio_data)) / peak_idx
        else:
            attack_rate = 0
        
        # ----- –°–ö–û–†–û–°–¢–¨ –ó–ê–¢–£–•–ê–ù–ò–Ø (DECAY) -----
        # –ö–∞–∫ –±—ã—Å—Ç—Ä–æ –∑–≤—É–∫ —Å—Ç–∏—Ö –ø–æ—Å–ª–µ –ø–∏–∫–∞
        after_peak = np.abs(audio_data[peak_idx:])
        if len(after_peak) > 1:
            decay_rate = (after_peak[0] - after_peak[-1]) / len(after_peak) if after_peak[0] > after_peak[-1] else 0
        else:
            decay_rate = 0
        
        return {
            "envelope": envelope_normalized,
            "spectrum": fft_normalized,
            "peak_position": peak_pos,
            "attack_rate": attack_rate,
            "decay_rate": decay_rate,
            "duration": len(audio_data) / self.rate
        }
    
    
    # ========================================================================
    # –°–†–ê–í–ù–ï–ù–ò–ï –° –≠–¢–ê–õ–û–ù–ê–ú–ò
    # ========================================================================
    
    def _compare_with_single_template(self, features: dict, template_features: dict) -> float:
        """
        –°—Ä–∞–≤–Ω–∏—Ç—å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∑–≤—É–∫–∞ —Å –æ–¥–Ω–∏–º —ç—Ç–∞–ª–æ–Ω–æ–º.
        
        –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
            features: —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º–æ–≥–æ –∑–≤—É–∫–∞
            template_features: —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —ç—Ç–∞–ª–æ–Ω–∞
        
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
            float –æ—Ç 0.0 –¥–æ 1.0 - –Ω–∞—Å–∫–æ–ª—å–∫–æ –ø–æ—Ö–æ–∂–µ (1.0 = –∏–¥–µ–∞–ª—å–Ω–æ)
        """
        
        # ----- 1. –°–†–ê–í–ù–ï–ù–ò–ï –û–ì–ò–ë–ê–Æ–©–ò–• (35% –≤–µ—Å–∞) -----
        # –ü—Ä–∏–≤–æ–¥–∏–º –∫ –æ–¥–Ω–æ–π –¥–ª–∏–Ω–µ –∏ —Å—á–∏—Ç–∞–µ–º –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—é
        target_len = min(len(features["envelope"]), len(template_features["envelope"]))
        
        # –ò–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è (—Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ–º/—Å–∂–∏–º–∞–µ–º –¥–æ –æ–¥–Ω–æ–π –¥–ª–∏–Ω—ã)
        env1 = np.interp(
            np.linspace(0, 1, target_len), 
            np.linspace(0, 1, len(features["envelope"])), 
            features["envelope"]
        )
        env2 = np.interp(
            np.linspace(0, 1, target_len), 
            np.linspace(0, 1, len(template_features["envelope"])), 
            template_features["envelope"]
        )
        
        # –ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è (–Ω–∞—Å–∫–æ–ª—å–∫–æ —Ñ–æ—Ä–º—ã –ø–æ—Ö–æ–∂–∏)
        correlation = np.corrcoef(env1, env2)[0, 1]
        if np.isnan(correlation):
            correlation = 0
        envelope_similarity = max(0, correlation)
        
        # ----- 2. –°–†–ê–í–ù–ï–ù–ò–ï –°–ü–ï–ö–¢–†–û–í (35% –≤–µ—Å–∞) -----
        spec_len = min(len(features["spectrum"]), len(template_features["spectrum"]))
        spec1 = features["spectrum"][:spec_len]
        spec2 = template_features["spectrum"][:spec_len]
        
        spec_correlation = np.corrcoef(spec1, spec2)[0, 1]
        if np.isnan(spec_correlation):
            spec_correlation = 0
        spectrum_similarity = max(0, spec_correlation)
        
        # ----- 3. –°–†–ê–í–ù–ï–ù–ò–ï –ü–û–ó–ò–¶–ò–ò –ü–ò–ö–ê (15% –≤–µ—Å–∞) -----
        # –ß–µ–º –±–ª–∏–∂–µ –ø–æ–∑–∏—Ü–∏–∏ –ø–∏–∫–æ–≤ - —Ç–µ–º –ª—É—á—à–µ
        peak_diff = abs(features["peak_position"] - template_features["peak_position"])
        peak_similarity = max(0, 1 - peak_diff * 3)
        
        # ----- 4. –°–†–ê–í–ù–ï–ù–ò–ï –°–ö–û–†–û–°–¢–ò –ù–ê–†–ê–°–¢–ê–ù–ò–Ø (15% –≤–µ—Å–∞) -----
        attack_ratio = min(features["attack_rate"], template_features["attack_rate"]) / \
                       (max(features["attack_rate"], template_features["attack_rate"]) + 0.0001)
        
        # ----- –ò–¢–û–ì–û–í–ê–Ø –ü–û–•–û–ñ–ï–°–¢–¨ -----
        # –í–∑–≤–µ—à–µ–Ω–Ω–∞—è —Å—É–º–º–∞ –≤—Å–µ—Ö –º–µ—Ç—Ä–∏–∫
        total_similarity = (
            envelope_similarity * 0.35 +   # –§–æ—Ä–º–∞ –≥—Ä–æ–º–∫–æ—Å—Ç–∏
            spectrum_similarity * 0.35 +   # –ß–∞—Å—Ç–æ—Ç–Ω—ã–π —Å–æ—Å—Ç–∞–≤
            peak_similarity * 0.15 +       # –ü–æ–∑–∏—Ü–∏—è –ø–∏–∫–∞
            attack_ratio * 0.15            # –°–∫–æ—Ä–æ—Å—Ç—å –∞—Ç–∞–∫–∏
        )
        
        return total_similarity
    
    def _compare_with_template(self, audio_data: np.ndarray) -> float:
        """
        –°—Ä–∞–≤–Ω–∏—Ç—å –∑–≤—É–∫ —Å –û–ë–û–ò–ú–ò —ç—Ç–∞–ª–æ–Ω–∞–º–∏ –∏ –≤–µ—Ä–Ω—É—Ç—å –ª—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç.
        
        –ó–∞—á–µ–º –¥–≤–∞ —ç—Ç–∞–ª–æ–Ω–∞:
        - –ï—Å–ª–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω –±–ª–∏–∑–∫–æ - –∑–≤—É–∫ –ø–æ—Ö–æ–∂ –Ω–∞ template_close
        - –ï—Å–ª–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω –¥–∞–ª–µ–∫–æ - –∑–≤—É–∫ –ø–æ—Ö–æ–∂ –Ω–∞ template_far
        - –ë–µ—Ä—ë–º –ª—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        
        –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
            audio_data: –º–∞—Å—Å–∏–≤ —Å –∞—É–¥–∏–æ –¥–∞–Ω–Ω—ã–º–∏
        
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
            float - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø–æ—Ö–æ–∂–µ—Å—Ç—å (0.0 - 1.0)
        """
        # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –≤—Ö–æ–¥–Ω–æ–≥–æ –∑–≤—É–∫–∞
        features = self._extract_features(audio_data)
        
        # –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å —ç—Ç–∞–ª–æ–Ω–æ–º "–±–ª–∏–∑–∫–æ"
        similarity_close = self._compare_with_single_template(features, self.template_close_features)
        
        # –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å —ç—Ç–∞–ª–æ–Ω–æ–º "–¥–∞–ª–µ–∫–æ"
        similarity_far = self._compare_with_single_template(features, self.template_far_features)
        
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ª—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        return max(similarity_close, similarity_far)
    
    
    # ========================================================================
    # –†–ê–ë–û–¢–ê –° –ú–ò–ö–†–û–§–û–ù–û–ú
    # ========================================================================
    
    def start_stream(self):
        """
        –ó–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞–ø–∏—Å—å —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞.
        
        –û—Ç–∫—Ä—ã–≤–∞–µ–º –∞—É–¥–∏–æ –ø–æ—Ç–æ–∫ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:
        - 16 –±–∏—Ç (–∫–∞—á–µ—Å—Ç–≤–æ –∑–≤—É–∫–∞)
        - –ú–æ–Ω–æ (–æ–¥–∏–Ω –∫–∞–Ω–∞–ª)
        - 44100 Hz (—á–∞—Å—Ç–æ—Ç–∞ –¥–∏—Å–∫—Ä–µ—Ç–∏–∑–∞—Ü–∏–∏)
        """
        self.stream = self.audio.open(
            format=pyaudio.paInt16,          # 16-–±–∏—Ç–Ω—ã–π –∑–≤—É–∫
            channels=self.channels,           # 1 = –º–æ–Ω–æ
            rate=self.rate,                   # 44100 Hz
            input=True,                       # –≠—Ç–æ –≤—Ö–æ–¥ (–º–∏–∫—Ä–æ—Ñ–æ–Ω), –Ω–µ –≤—ã—Ö–æ–¥
            frames_per_buffer=self.chunk      # –†–∞–∑–º–µ—Ä –±—É—Ñ–µ—Ä–∞
        )
        self.is_running = True
        print("üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω. –ò—â—É –∑–≤—É–∫ –æ—Ç–∫—Ä—ã—Ç–∏—è –±–∞–Ω–∫–∏...")
    
    def stop_stream(self):
        """
        –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞.
        
        –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ—Ç–æ–∫ –∏ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º —Ä–µ—Å—É—Ä—Å—ã.
        """
        self.is_running = False
        if self.stream:
            self.stream.stop_stream()
            self.stream.close()
        self.audio.terminate()
        print("üîá –ú–∏–∫—Ä–æ—Ñ–æ–Ω –æ—Ç–∫–ª—é—á–µ–Ω.")
    
    def read_audio_chunk(self) -> np.ndarray:
        """
        –ü—Ä–æ—á–∏—Ç–∞—Ç—å –ø–æ—Ä—Ü–∏—é –∞—É–¥–∏–æ –¥–∞–Ω–Ω—ã—Ö —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞.
        
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
            numpy –º–∞—Å—Å–∏–≤ —Å –∞—É–¥–∏–æ –¥–∞–Ω–Ω—ã–º–∏ (int16)
        """
        try:
            # –ß–∏—Ç–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø–æ—Ç–æ–∫–∞
            data = self.stream.read(self.chunk, exception_on_overflow=False)
            # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –±–∞–π—Ç—ã –≤ —á–∏—Å–ª–∞
            return np.frombuffer(data, dtype=np.int16)
        except Exception as e:
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –∞—É–¥–∏–æ: {e}")
            return np.zeros(self.chunk, dtype=np.int16)
    
    
    # ========================================================================
    # –ì–õ–ê–í–ù–´–ô –ú–ï–¢–û–î –î–ï–¢–ï–ö–¶–ò–ò
    # ========================================================================
    
    def detect(self) -> bool:
        """
        –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –±—ã–ª –ª–∏ –∑–≤—É–∫ –æ—Ç–∫—Ä—ã—Ç–∏—è –±–∞–Ω–∫–∏.
        
        –≠—Ç–æ—Ç –º–µ—Ç–æ–¥ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ —Ü–∏–∫–ª–µ –∏–∑ gui_app.py.
        
        –ê–ª–≥–æ—Ä–∏—Ç–º:
        1. –ü—Ä–æ–≤–µ—Ä—è–µ–º cooldown (3 —Å–µ–∫ –º–µ–∂–¥—É —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è–º–∏)
        2. –ß–∏—Ç–∞–µ–º –∞—É–¥–∏–æ —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
        3. –ï—Å–ª–∏ —Ç–∏—Ö–æ - –æ–±–Ω–æ–≤–ª—è–µ–º —Ñ–æ–Ω–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å
        4. –ï—Å–ª–∏ –≥—Ä–æ–º–∫–æ - –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∑–≤—É–∫
        5. –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å —ç—Ç–∞–ª–æ–Ω–æ–º
        6. –ï—Å–ª–∏ –ø–æ—Ö–æ–∂–µ > 55% - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º True
        
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
            True  - –æ–±–Ω–∞—Ä—É–∂–µ–Ω –∑–≤—É–∫ –æ—Ç–∫—Ä—ã—Ç–∏—è –±–∞–Ω–∫–∏
            False - –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω (–∏–ª–∏ cooldown)
        """
        current_time = time.time()
        
        # ----- COOLDOWN -----
        # –ù–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —á–∞—â–µ —á–µ–º —Ä–∞–∑ –≤ 3 —Å–µ–∫—É–Ω–¥—ã
        if current_time - self.last_trigger_time < self.cooldown:
            return False
        
        # ----- –ß–ò–¢–ê–ï–ú –ê–£–î–ò–û -----
        audio_data = self.read_audio_chunk()
        
        # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º (–ø—Ä–∏–≤–æ–¥–∏–º –∫ –¥–∏–∞–ø–∞–∑–æ–Ω—É -1.0 ... +1.0)
        audio_normalized = audio_data / 32768.0  # 32768 = –º–∞–∫—Å–∏–º—É–º –¥–ª—è int16
        
        # –î–æ–±–∞–≤–ª—è–µ–º –≤ –±—É—Ñ–µ—Ä (–Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ–º 300–º—Å)
        self.audio_buffer.extend(audio_normalized)
        
        # ----- –í–´–ß–ò–°–õ–Ø–ï–ú –£–†–û–í–ù–ò -----
        # RMS (Root Mean Square) - —Å—Ä–µ–¥–Ω—è—è –≥—Ä–æ–º–∫–æ—Å—Ç—å
        rms = np.sqrt(np.mean(audio_normalized ** 2))
        
        # Peak - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≥—Ä–æ–º–∫–æ—Å—Ç—å
        peak = np.max(np.abs(audio_normalized))
        
        # ----- –ê–î–ê–ü–¢–ò–í–ù–´–ô –§–û–ù–û–í–´–ô –£–†–û–í–ï–ù–¨ -----
        # –ï—Å–ª–∏ —Ç–∏—Ö–æ - –∑–∞–ø–æ–º–∏–Ω–∞–µ–º –∫–∞–∫ "—Ñ–æ–Ω"
        if rms < 0.02:
            self.background_levels.append(rms)
            if len(self.background_levels) > 5:
                self.background_level = np.mean(self.background_levels)
        
        # ----- –û–¢–õ–ê–î–û–ß–ù–´–ô –í–´–í–û–î -----
        if self.debug_mode and current_time - self.last_debug_time >= 0.5:
            self.last_debug_time = current_time
            # –†–∏—Å—É–µ–º –ø–æ–ª–æ—Å–∫—É –≥—Ä–æ–º–∫–æ—Å—Ç–∏
            bar_length = int(rms * 200)
            bar = "‚ñà" * min(bar_length, 50) + "‚ñë" * (50 - min(bar_length, 50))
            status = "üîä" if peak > self.peak_threshold else "üîà"
            print(f"{status} [{bar}] RMS:{rms:.3f} Peak:{peak:.3f}", end="\r")
        
        # ----- –ê–ù–ê–õ–ò–ó –ì–†–û–ú–ö–ò–• –ó–í–£–ö–û–í -----
        # –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–∏–∫ –≤—ã—à–µ –ø–æ—Ä–æ–≥–∞ - –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º
        if peak > self.peak_threshold:
            
            # –ë–µ—Ä—ë–º –≤–µ—Å—å –±—É—Ñ–µ—Ä –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
            buffer_array = np.array(self.audio_buffer)
            
            # –ù–∞—Ö–æ–¥–∏–º –ø–∏–∫ –∏ –≤—ã—Ä–µ–∑–∞–µ–º –æ–∫–Ω–æ –≤–æ–∫—Ä—É–≥ –Ω–µ–≥–æ
            # 50–º—Å –¥–æ –ø–∏–∫–∞, 150–º—Å –ø–æ—Å–ª–µ (—Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω–æ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –±–∞–Ω–∫–∏)
            peak_idx = np.argmax(np.abs(buffer_array))
            samples_before = int(self.rate * 0.05)   # 50–º—Å
            samples_after = int(self.rate * 0.15)    # 150–º—Å
            
            start_idx = max(0, peak_idx - samples_before)
            end_idx = min(len(buffer_array), peak_idx + samples_after)
            
            segment = buffer_array[start_idx:end_idx]
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
            if len(segment) > 1000:
                
                # –°–†–ê–í–ù–ò–í–ê–ï–ú –° –≠–¢–ê–õ–û–ù–û–ú!
                similarity = self._compare_with_template(segment)
                
                if self.debug_mode:
                    print(f"\n   üìä –ü–æ—Ö–æ–∂–µ—Å—Ç—å –Ω–∞ —ç—Ç–∞–ª–æ–Ω: {similarity:.1%}")
                
                # –ï—Å–ª–∏ –ø–æ—Ö–æ–∂–µ—Å—Ç—å –≤—ã—à–µ –ø–æ—Ä–æ–≥–∞ - —ç—Ç–æ –ø–∏–≤–æ!
                if similarity >= self.similarity_threshold:
                    print(f"\n\nüç∫ –ë–ê–ù–ö–ê –û–¢–ö–†–´–¢–ê! (–ø–æ—Ö–æ–∂–µ—Å—Ç—å: {similarity:.1%})")
                    self.last_trigger_time = current_time
                    self.audio_buffer.clear()  # –û—á–∏—â–∞–µ–º –±—É—Ñ–µ—Ä
                    return True
                    
                elif similarity > 0.3:
                    # –ü–æ—Ö–æ–∂–µ, –Ω–æ –Ω–µ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ
                    if self.debug_mode:
                        print(f"   ‚ùå –ù–µ –ø–æ—Ö–æ–∂–µ –Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∏–µ –±–∞–Ω–∫–∏ ({similarity:.1%})")
        
        return False
